# Loan API - Yii2 Application

API система для подачи и обработки заявок на займы, построенная на фреймворке Yii2 с использованием PostgreSQL и Docker контейнеризации.

## Технические требования

- **Фреймворк**: Yii2
- **Веб-сервер**: Nginx
- **База данных**: PostgreSQL
- **Контейнеризация**: Docker Compose
- **PHP**: 8.4.2

## Структура проекта

```
.
├── app/                    # Yii2 приложение
│   ├── config/            # Конфигурационные файлы
│   ├── controllers/       # Контроллеры API
│   ├── models/           # Модели данных
│   ├── services/         # Бизнес-логика
│   ├── migrations/       # Миграции базы данных
│   ├── web/              # Веб-директория
│   └── composer.json     # PHP зависимости
├── docker/               # Docker конфигурации
│   ├── nginx/           # Nginx конфигурация
│   ├── php/             # PHP-FPM Dockerfile
│   └── postgres/        # PostgreSQL инициализация
├── docker-compose.yml    # Docker Compose конфигурация
└── README.md            # Документация


## API Эндпоинты

### 1. Подача заявки на займ

**POST** `/requests`

**Тело запроса:**
```json
{
  "user_id": 1,
  "amount": 3000,
  "term": 30
}
```

**Успешный ответ (201):**
```json
{
  "result": true,
  "id": 42
}
```

**Ошибка валидации (400):**
```json
{
  "result": false
}
```

### 2. Обработка заявок

**GET** `/processor?delay=5`

**Параметры:**
- `delay` (integer) - время задержки в секундах для эмуляции обработки

**Ответ (200):**
```json
{
  "result": true
}
```

## Установка и запуск

### Шаги установки

1. **Клонирование репозитория**
   ```bash
   git clone <ссылка на репозиторий(еще не залил)>
   cd Test-work-hh
   ```

2. **Запуск контейнеров**
   ```bash
   docker-compose up -d
   ```

3. **Установка зависимостей PHP**
   ```bash
   docker-compose exec php-fpm composer install
   ```

4. **Выполнение миграций**
   ```bash
   docker-compose exec php-fpm php yii migrate --interactive=0
   ```

5. **Проверка работоспособности**
   
   Приложение будет доступно по адресу: `http://localhost` // Вывод состояния при желании можно заменить на  health 
   
   База данных доступна по адресу: `localhost:5432`
   - Database: `loans`
   - User: `user`
   - Password: `password`

### Тестирование API

**Создание заявки:**
```bash
curl -X POST http://localhost/requests \
  -H "Content-Type: application/json" \
  -d '{"user_id": 5, "amount": 15000, "term": 45}'
```

**Обработка заявок:**
```bash
curl "http://localhost/processor?delay=2"
```

## Архитектура

### Компоненты системы

1. **Nginx** - веб-сервер, проксирует запросы к PHP-FPM
2. **PHP-FPM** - app
3. **PostgreSQL** - база данных

### Модули приложения

- **LoanRequest** (Model) - модель заявки на займ с валидацией
- **LoanService** (Service) - бизнес-логика обработки займов
- **RequestsController** - обработка создания заявок
- **ProcessorController** - обработка заявок с рандомным принятием решений

### Бизнес-логика

- Вероятность одобрения заявки: **10%**
- У одного пользователя может быть только **одна одобренная заявка**
- Заявки обрабатываются с эмуляцией задержки через `sleep()`
- Параллельная обработка заявок одного пользователя разрешена

## База данных

### Таблица `loan_requests`

| Поле | Тип | Описание |
|------|-----|----------|
| id | SERIAL | Первичный ключ |
| user_id | INTEGER | ID пользователя |
| amount | INTEGER | Сумма займа |
| term | INTEGER | Срок займа в днях |
| status | VARCHAR(20) | Статус: pending/approved/declined |
| created_at | TIMESTAMP | Дата создания |
| updated_at | TIMESTAMP | Дата обновления |

### Индексы

- `idx_loan_requests_user_id` - по user_id
- `idx_loan_requests_status` - по статусу
- `idx_loan_requests_created_at` - по дате создания
- `idx_loan_requests_user_status` - составной по user_id и status

## Разработка

### Стандарты кода

- **PSR-12** - стандарт кодирования PHP
- **Модульная архитектура** - разделение на контроллеры, сервисы, модели

## Остановка приложения

```bash
# Остановка контейнеров
docker-compose down

## Время выполнения задания

**Общее время разработки: ~4 часа**

### Детализация по этапам:

- **Анализ требований и планирование архитектуры**: 30 минут
- **Настройка Docker окружения**: 45 минут
- **Создание структуры Yii2 приложения**: 30 минут
- **Разработка моделей и сервисов**: 60 минут
- **Создание контроллеров API**: 45 минут
- **Настройка базы данных и миграций**: 30 минут
- **Тестирование и отладка**: 45 минут
- **Документация**: 30 минут

### Использованные технологии и подходы:

- **Docker Compose** для контейнеризации
- **Yii2 Framework** с ActiveRecord ORM
- **PostgreSQL** с индексами для оптимизации
- **PSR-12** стандарты кодирования
- **Service Layer** для бизнес-логики
- **RESTful API** дизайн
- **Транзакции БД** для консистентности данных
- **Логирование** для мониторинга