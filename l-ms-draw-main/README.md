# MS Draw Service

–ú–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å –¥–ª—è –ø—Ä–æ–≤–µ–¥–µ–Ω–∏—è —Ä–æ–∑—ã–≥—Ä—ã—à–µ–π –ª–æ—Ç–µ—Ä–µ–π.

## –û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏

- –ü–æ–ª—É—á–µ–Ω–∏–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–π –ª–æ—Ç–µ—Ä–µ–π —á–µ—Ä–µ–∑ Kafka
- –ü–æ–ª—É—á–µ–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –ø—Ä–∏–∑–æ–≤—ã—Ö –º–µ—Å—Ç
- –ü–æ–ª—É—á–µ–Ω–∏–µ –±–∏–ª–µ—Ç–æ–≤ –∏–∑ —Ç–∏–ø–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö —Ç–æ–ø–∏–∫–æ–≤ (daily_fixed, daily_dynamic, jackpot, supertour)
- –ü—Ä–æ–≤–µ–¥–µ–Ω–∏–µ —Ä–æ–∑—ã–≥—Ä—ã—à–µ–π –∏ –æ—Ç–ø—Ä–∞–≤–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
- –ü–∞—Ä—Ç–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –±–∏–ª–µ—Ç–æ–≤ –ø–æ lottery_id –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Ç–∏–ø–∞ –ª–æ—Ç–µ—Ä–µ–∏

## –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç

### –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ env
```bash
cp -i .env.example .env 
```

### –ó–∞–ø—É—Å–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
```bash 
make up
```

### –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
```bash 
make down
```

### –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–π
```bash 
docker exec -it ms-draw-service composer phinx-migrate-up
```

## –ö–æ–Ω—Å—å—é–º–µ—Ä—ã

### –ö–æ–Ω—Å—å—é–º–µ—Ä—ã –±–∏–ª–µ—Ç–æ–≤

–î–ª—è –∫–∞–∂–¥–æ–≥–æ —Ç–∏–ø–∞ –ª–æ—Ç–µ—Ä–µ–∏ –µ—Å—Ç—å –æ—Ç–¥–µ–ª—å–Ω—ã–π –∫–æ–Ω—Å—å—é–º–µ—Ä:

```bash
# –ö–æ–Ω—Å—å—é–º–µ—Ä –±–∏–ª–µ—Ç–æ–≤ daily_fixed –ª–æ—Ç–µ—Ä–µ–π
docker exec -it ms-draw-service php webman consume-tickets:daily-fixed

# –ö–æ–Ω—Å—å—é–º–µ—Ä –±–∏–ª–µ—Ç–æ–≤ daily_dynamic –ª–æ—Ç–µ—Ä–µ–π  
docker exec -it ms-draw-service php webman consume-tickets:daily-dynamic

# –ö–æ–Ω—Å—å—é–º–µ—Ä –±–∏–ª–µ—Ç–æ–≤ jackpot –ª–æ—Ç–µ—Ä–µ–π
docker exec -it ms-draw-service php webman consume-tickets:jackpot

# –ö–æ–Ω—Å—å—é–º–µ—Ä –±–∏–ª–µ—Ç–æ–≤ supertour –ª–æ—Ç–µ—Ä–µ–π
docker exec -it ms-draw-service php webman consume-tickets:supertour
```

### –°–∏—Å—Ç–µ–º–Ω—ã–µ –∫–æ–Ω—Å—å—é–º–µ—Ä—ã

```bash
# –ö–æ–Ω—Å—å—é–º–µ—Ä —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–π –ª–æ—Ç–µ—Ä–µ–π
docker exec -it ms-draw-service php webman consume-schedules:run

# –ö–æ–Ω—Å—å—é–º–µ—Ä –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ —Ä–æ–∑—ã–≥—Ä—ã—à–µ–π  
docker exec -it ms-draw-service php webman consume-draw-config:run
```

### –ö–æ–º–∞–Ω–¥—ã —Ä–æ–∑—ã–≥—Ä—ã—à–∞

```bash
# –ü—Ä–æ–≤–µ–¥–µ–Ω–∏–µ —Ä–æ–∑—ã–≥—Ä—ã—à–µ–π –ª–æ—Ç–µ—Ä–µ–π
docker exec -it ms-draw-service php webman draw:lotteries
```

## –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

### –¢–æ–ø–∏–∫–∏ Kafka

**–í—Ö–æ–¥—è—â–∏–µ:**
- `daily_fixed_tickets_v1` - –±–∏–ª–µ—Ç—ã –µ–∂–µ–¥–Ω–µ–≤–Ω—ã—Ö –ª–æ—Ç–µ—Ä–µ–π —Å —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–º –ø—Ä–∏–∑–æ–º
- `daily_dynamic_tickets_v1` - –±–∏–ª–µ—Ç—ã –µ–∂–µ–¥–Ω–µ–≤–Ω—ã—Ö –ª–æ—Ç–µ—Ä–µ–π —Å –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–º –ø—Ä–∏–∑–æ–º  
- `jackpot_tickets_v1` - –±–∏–ª–µ—Ç—ã –¥–∂–µ–∫–ø–æ—Ç –ª–æ—Ç–µ—Ä–µ–π
- `supertour_tickets_v1` - –±–∏–ª–µ—Ç—ã —Å—É–ø–µ—Ä—Ç—É—Ä –ª–æ—Ç–µ—Ä–µ–π
- `lottery_schedules_v1` - —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è –ª–æ—Ç–µ—Ä–µ–π
- `lottery_draw_config_v1` - –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —Ä–æ–∑—ã–≥—Ä—ã—à–µ–π

**–ò—Å—Ö–æ–¥—è—â–∏–µ:**
- `lottery_draw_results_v1` - —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ä–æ–∑—ã–≥—Ä—ã—à–µ–π

**DLQ (Dead Letter Queue):**
- `dlq_tickets_v1` - –Ω–µ—É–¥–∞—á–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è —Å –±–∏–ª–µ—Ç–∞–º–∏
- `dlq_schedules_v1` - –Ω–µ—É–¥–∞—á–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è —Å —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è–º–∏

### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ë–î

**–û—Å–Ω–æ–≤–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞:**
- `lottery_numbers` - –≤—Å–µ –ª–æ—Ç–µ—Ä–µ–∏ –≤—Å–µ—Ö —Ç–∏–ø–æ–≤

**–ü–∞—Ä—Ç–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ç–∞–±–ª–∏—Ü—ã –±–∏–ª–µ—Ç–æ–≤:**
- `daily_fixed_tickets` - –±–∏–ª–µ—Ç—ã –µ–∂–µ–¥–Ω–µ–≤–Ω—ã—Ö –ª–æ—Ç–µ—Ä–µ–π —Å —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–º –ø—Ä–∏–∑–æ–º
- `daily_dynamic_tickets` - –±–∏–ª–µ—Ç—ã –µ–∂–µ–¥–Ω–µ–≤–Ω—ã—Ö –ª–æ—Ç–µ—Ä–µ–π —Å –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–º –ø—Ä–∏–∑–æ–º
- `jackpot_tickets` - –±–∏–ª–µ—Ç—ã –¥–∂–µ–∫–ø–æ—Ç –ª–æ—Ç–µ—Ä–µ–π
- `supertour_tickets` - –±–∏–ª–µ—Ç—ã —Å—É–ø–µ—Ä—Ç—É—Ä –ª–æ—Ç–µ—Ä–µ–π

–ö–∞–∂–¥–∞—è —Ç–∞–±–ª–∏—Ü–∞ –±–∏–ª–µ—Ç–æ–≤ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ–∑–¥–∞–µ—Ç –ø–∞—Ä—Ç–∏—Ü–∏–∏ –ø–æ `lottery_id`.

### –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

–ö–∞–∂–¥—ã–π –∫–æ–Ω—Å—å—é–º–µ—Ä –ø–∏—à–µ—Ç –ª–æ–≥–∏ –≤ –æ—Ç–¥–µ–ª—å–Ω—ã–π —Ñ–∞–π–ª:
- `runtime/logs/command_consume_daily_fixed_tickets.log`
- `runtime/logs/command_consume_daily_dynamic_tickets.log`
- `runtime/logs/command_consume_jackpot_tickets.log`
- `runtime/logs/command_consume_supertour_tickets.log`
- `runtime/logs/command_consume_schedules.log`
- `runtime/logs/command_consume_draw_config.log`

## –õ–æ–∫–∞–ª—å–Ω–∞—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞

### –ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—ã–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è

–ü–µ—Ä–µ–¥ –∑–∞–ø—É—Å–∫–æ–º —É–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —É –≤–∞—Å –∑–∞–ø—É—â–µ–Ω–∞ –æ–±—â–∞—è –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞:

```bash
cd ../shared-infra
docker-compose up -d
```

### –ó–∞–ø—É—Å–∫ –º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å–∞

1. –ö–ª–æ–Ω–∏—Ä—É–π—Ç–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π:
```bash
git clone <url-—Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è> ms-draw-service
cd ms-draw-service
```

2. –°–æ–∑–¥–∞–π—Ç–µ .env —Ñ–∞–π–ª:
```bash
cp .env.example .env
```

3. –ó–∞–ø—É—Å—Ç–∏—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ:
```bash
docker-compose up -d
```

–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–Ω–æ –ø–æ –∞–¥—Ä–µ—Å—É: http://localhost:8086

### –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö

–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è PostgreSQL –±–∞–∑–∞ `ms_draw` –∏–∑ –æ–±—â–µ–π –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã.
–ë–∞–∑–∞ —Å–æ–∑–¥–∞–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ shared-infra.

### –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ—Ü–µ—Å—Å—ã

–ú–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–ø—É—Å–∫–∞–µ—Ç —Å–ª–µ–¥—É—é—â–∏–µ –ø—Ä–æ—Ü–µ—Å—Å—ã:

### üé≤ –ü—Ä–æ—Ü–µ—Å—Å —Ä–æ–∑—ã–≥—Ä—ã—à–µ–π (`DrawLotteryProcess`)
- **–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ**: –∫–∞–∂–¥—ã–µ 5 –º–∏–Ω—É—Ç (`*/5 * * * *`)
- **–§—É–Ω–∫—Ü–∏—è**: –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –≥–æ—Ç–æ–≤—ã–µ –∫ —Ä–æ–∑—ã–≥—Ä—ã—à—É –ª–æ—Ç–µ—Ä–µ–∏ –∏ –ø—Ä–æ–≤–æ–¥–∏—Ç –∏—Ö
- **–õ–æ–≥**: `runtime/logs/process_draw_lottery.log`

### üìÖ –ü—Ä–æ—Ü–µ—Å—Å –∫–æ–Ω—Å—å—é–º–µ—Ä–∞ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–π (`ConsumeSchedulesProcess`)
- **–¢–∏–ø**: –ø–æ—Å—Ç–æ—è–Ω–Ω–æ —Ä–∞–±–æ—Ç–∞—é—â–∏–π –ø—Ä–æ—Ü–µ—Å—Å
- **–§—É–Ω–∫—Ü–∏—è**: –ø–æ–ª—É—á–∞–µ—Ç —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è –ª–æ—Ç–µ—Ä–µ–π –∏–∑ Kafka —Ç–æ–ø–∏–∫–∞ `lottery_schedules_v1`
- **–ê–≤—Ç–æ–ø–µ—Ä–µ–∑–∞–ø—É—Å–∫**: —á–µ—Ä–µ–∑ 10 —Å–µ–∫—É–Ω–¥ –ø—Ä–∏ –Ω–æ—Ä–º–∞–ª—å–Ω–æ–º –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏, —á–µ—Ä–µ–∑ 30 —Å–µ–∫—É–Ω–¥ –ø—Ä–∏ –æ—à–∏–±–∫–µ
- **–õ–æ–≥**: `runtime/logs/process_consume_schedules.log`

### üèÜ –ü—Ä–æ—Ü–µ—Å—Å –∫–æ–Ω—Å—å—é–º–µ—Ä–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ (`ConsumeDrawConfigProcess`)
- **–¢–∏–ø**: –ø–æ—Å—Ç–æ—è–Ω–Ω–æ —Ä–∞–±–æ—Ç–∞—é—â–∏–π –ø—Ä–æ—Ü–µ—Å—Å
- **–§—É–Ω–∫—Ü–∏—è**: –ø–æ–ª—É—á–∞–µ—Ç –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –ø—Ä–∏–∑–æ–≤—ã—Ö –º–µ—Å—Ç –∏–∑ Kafka —Ç–æ–ø–∏–∫–∞ `lottery_draw_config_v1`
- **–ê–≤—Ç–æ–ø–µ—Ä–µ–∑–∞–ø—É—Å–∫**: —á–µ—Ä–µ–∑ 10 —Å–µ–∫—É–Ω–¥ –ø—Ä–∏ –Ω–æ—Ä–º–∞–ª—å–Ω–æ–º –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏, —á–µ—Ä–µ–∑ 30 —Å–µ–∫—É–Ω–¥ –ø—Ä–∏ –æ—à–∏–±–∫–µ
- **–õ–æ–≥**: `runtime/logs/process_consume_draw_config.log`

### üéüÔ∏è –ü—Ä–æ—Ü–µ—Å—Å –∫–æ–Ω—Å—å—é–º–µ—Ä–æ–≤ –±–∏–ª–µ—Ç–æ–≤ (`ConsumeTicketsProcess`)
- **–¢–∏–ø**: –ø–æ—Å—Ç–æ—è–Ω–Ω–æ —Ä–∞–±–æ—Ç–∞—é—â–∏–µ –ø—Ä–æ—Ü–µ—Å—Å—ã (4 –∫–æ–Ω—Å—å—é–º–µ—Ä–∞)
- **–§—É–Ω–∫—Ü–∏—è**: –ø–æ–ª—É—á–∞–µ—Ç –±–∏–ª–µ—Ç—ã –≤—Å–µ—Ö —Ç–∏–ø–æ–≤ –∏–∑ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏—Ö Kafka —Ç–æ–ø–∏–∫–æ–≤:
  - `daily_fixed_tickets_v1`
  - `daily_dynamic_tickets_v1`
  - `jackpot_tickets_v1`
  - `supertour_tickets_v1`
- **–ê–≤—Ç–æ–ø–µ—Ä–µ–∑–∞–ø—É—Å–∫**: —á–µ—Ä–µ–∑ 10 —Å–µ–∫—É–Ω–¥ –ø—Ä–∏ –Ω–æ—Ä–º–∞–ª—å–Ω–æ–º –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏, —á–µ—Ä–µ–∑ 30 —Å–µ–∫—É–Ω–¥ –ø—Ä–∏ –æ—à–∏–±–∫–µ
- **–õ–æ–≥**: `runtime/logs/process_consume_tickets.log`

## –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

### –ü—Ä–æ—Å–º–æ—Ç—Ä –ª–æ–≥–æ–≤ –ø—Ä–æ—Ü–µ—Å—Å–æ–≤:
```bash
# –õ–æ–≥ –ø—Ä–æ—Ü–µ—Å—Å–∞ —Ä–æ–∑—ã–≥—Ä—ã—à–µ–π
docker exec -it ms-draw-service tail -f runtime/logs/process_draw_lottery.log

# –õ–æ–≥ –ø—Ä–æ—Ü–µ—Å—Å–∞ –∫–æ–Ω—Å—å—é–º–µ—Ä–∞ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–π
docker exec -it ms-draw-service tail -f runtime/logs/process_consume_schedules.log

# –õ–æ–≥ –ø—Ä–æ—Ü–µ—Å—Å–∞ –∫–æ–Ω—Å—å—é–º–µ—Ä–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
docker exec -it ms-draw-service tail -f runtime/logs/process_consume_draw_config.log

# –õ–æ–≥ –ø—Ä–æ—Ü–µ—Å—Å–∞ –∫–æ–Ω—Å—å—é–º–µ—Ä–æ–≤ –±–∏–ª–µ—Ç–æ–≤
docker exec -it ms-draw-service tail -f runtime/logs/process_consume_tickets.log

# –ü—Ä–æ—Å–º–æ—Ç—Ä –≤—Å–µ—Ö –ª–æ–≥–æ–≤ –ø—Ä–æ—Ü–µ—Å—Å–æ–≤
docker exec -it ms-draw-service tail -f runtime/logs/process_*.log
```

### –ü—Ä–æ—Å–º–æ—Ç—Ä –ª–æ–≥–æ–≤ –∫–æ–Ω—Å—å—é–º–µ—Ä–æ–≤:
```bash
# –õ–æ–≥–∏ –æ—Ç–¥–µ–ª—å–Ω—ã—Ö –∫–æ–Ω—Å—å—é–º–µ—Ä–æ–≤ –±–∏–ª–µ—Ç–æ–≤
docker exec -it ms-draw-service tail -f runtime/logs/command_consume_daily_fixed_tickets.log
docker exec -it ms-draw-service tail -f runtime/logs/command_consume_daily_dynamic_tickets.log
docker exec -it ms-draw-service tail -f runtime/logs/command_consume_jackpot_tickets.log
docker exec -it ms-draw-service tail -f runtime/logs/command_consume_supertour_tickets.log

# –õ–æ–≥–∏ —Å–∏—Å—Ç–µ–º–Ω—ã—Ö –∫–æ–Ω—Å—å—é–º–µ—Ä–æ–≤
docker exec -it ms-draw-service tail -f runtime/logs/command_consume_schedules.log
docker exec -it ms-draw-service tail -f runtime/logs/command_consume_draw_config.log

# –ü—Ä–æ—Å–º–æ—Ç—Ä –≤—Å–µ—Ö –ª–æ–≥–æ–≤ –∫–æ–Ω—Å—å—é–º–µ—Ä–æ–≤
docker exec -it ms-draw-service tail -f runtime/logs/command_*.log
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –ø—Ä–æ—Ü–µ—Å—Å–æ–≤:
```bash
# –°—Ç–∞—Ç—É—Å –≤—Å–µ—Ö –ø—Ä–æ—Ü–µ—Å—Å–æ–≤
docker exec -it ms-draw-service php webman status

# –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ –≤—Å–µ—Ö –ø—Ä–æ—Ü–µ—Å—Å–æ–≤
docker exec -it ms-draw-service php webman restart
```
